
top_builddir=../../..
include $(top_builddir)/Makefile.conf

CFILES=int10.c int16.c int17.c hlt.c setup.c vgabios.c bios_symbols.c

all: lib

include $(REALTOPDIR)/src/Makefile.common

.INTERMEDIATE: bios_data

bios_data: bios.o
	# formal intermediate filename is necessary for xxd to name structure
	objcopy -j .text -O binary $< $@

bios_data.xxd: bios_data
	xxd -i $< $@

bios_symbols.c: bios.o
	nm -g -n $< | gawk '\
		BEGIN {\
		  COUNT=0;\
		  print "// Warning: autogenerated";\
	          print "";\
	          print "#include \"bios.h\"";\
	          print "";\
		  print "struct bios_symbol_entry bios_symbol[] = {";\
		}\
		{\
		  HEXSTR = sprintf("0x%s", $$1);\
		  ADDR = strtonum(HEXSTR);\
		  if (ADDR <= 0xffff) {\
		    COUNT++;\
		    printf "  { 0x%04x, \"%s\" },\n", ADDR, $$3;\
		  }\
		}\
		END {\
		  print "};";\
		  print "";\
	          print "int bios_symbol_num = " COUNT ";";\
		}\
		' > $@ || (rm -f $@ ; false)

bios_offsets.hh: bios.o
	nm -g -n $< | gawk '\
		BEGIN {\
		  print "// Warning: autogenerated";\
	          print "";\
		}\
		{\
		  HEXSTR = sprintf("0x%s", $$1);\
		  ADDR = strtonum(HEXSTR);\
		  if (ADDR <= 0xffff) {\
		    printf "#define %s 0x%04x\n", $$3, ADDR;\
		  }\
		}\
		END {\
		  print "";\
		}\
		' > $@ || (rm -f $@ ; false)
clean::
	rm -f *.s.out bios_symbols.c bios_offsets.hh bios_data.xxd bios_data
